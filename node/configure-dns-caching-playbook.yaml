---

- name: Configure DNS caching on all nodes
  hosts: nodes
  become: true
  tasks:
    - name: Install systemd-resolved
      ansible.builtin.dnf:
        name: systemd-resolved
        state: present
    - name: Enable systemd-resolved
      ansible.builtin.systemd_service:
        name: systemd-resolved
        enabled: true
        state: started
    - name: Check if /etc/resolv.conf is generated by NetworkManager
      ansible.builtin.lineinfile:
        path: /etc/resolv.conf
        line: "# Generated by NetworkManager"
        state: absent
      changed_when: false
      check_mode: true
      register: resolv_conf

    - name: Switch to systemd-resolved resolv.conf file
      when: resolv_conf.found
      block:
        - name: Remove old /etc/resolv.conf
          ansible.builtin.file:
            path: /etc/resolv.conf
            state: absent
        - name: Add systemd-resolved resolv.conf file
          ansible.builtin.file:
            src: /run/systemd/resolve/stub-resolv.conf
            dest: /etc/resolv.conf
            state: link
